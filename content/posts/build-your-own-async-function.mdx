---
title: Build Your Own Async Function
date: 2020-07-32
---

æœ¬æ–‡ä¼šä»¥ [co](https://github.com/tj/co) æºç ä¸ºå‚è€ƒï¼Œè‡ªå·±å®žçŽ°ä¸€ä¸ª `async function`ã€‚

## Generator

åœ¨å®žçŽ°ä¹‹å‰å…ˆäº†è§£ä¸€ä¸‹ `JS` ä¸­çš„ç”Ÿæˆå™¨ï¼Œå› ä¸º `async function` æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œçš„ç”Ÿæˆå™¨å‡½æ•°ã€‚

æ‰§è¡Œä¸€ä¸ª `generator function` æ—¶ï¼Œä¼šè¿”å›žä¸€ä¸ª `iterator`ï¼Œä¸”å‡½æ•°ä½“çš„ä»£ç å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œã€‚å½“æ‰§è¡Œè¿™ä¸ª `iterator` çš„ `next` æ–¹æ³•æ—¶ï¼Œ
ä¼šé‡æ–°è¿›å…¥å‡½æ•°å¹¶æ‰§è¡Œåˆ°é‡åˆ°çš„ç¬¬ä¸€ä¸ª `yield` è¯­å¥ï¼Œ`next` æ–¹æ³•å°†ä¼šè¿”å›žä¸€ä¸ªå¯¹è±¡:

```javascript
{
  value: "yield è¿”å›žå€¼"
  done: "æ˜¯å¦ yield äº†æœ€åŽä¸€ä¸ªå€¼"
}
```

ä¸¾ä¸ªä¾‹å­ðŸŒ°

```javascript
const foo = function* () {
  yield 10;
  yield 20;
};

const bar = foo();
console.log(bar.next()); // {value: 10, done: false}
```

## æ€è·¯

çŽ°åœ¨æœ‰ä¸‹é¢ä¸¤ä¸ªå‡½æ•°

```javascript
(async () => {
  await Promise.resolve(1)
})()

function* foo() {
  yield Promise.resolve(1)
}
```

ç”± `generator` çš„ç‰¹æ€§æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼šå¦‚æžœå¯ä»¥è®© `foo` å‡½æ•°è‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”æ¯æ¬¡ `yield` æ—¶ï¼Œè¿”å›žçš„æ˜¯ `yielded value` `resolve` åŽçš„å€¼ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯ç›¸ç­‰çš„äº†ã€‚
å› æ­¤æˆ‘ä»¬æœ€ç»ˆçš„è°ƒç”¨æ–¹æ³•æ˜¯

```javascript
co(function* () {
  yield Promise.resolve(1)
})
```

## å®žçŽ°

`co` çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª `generator function`ï¼ŒåŽé¢å¯ä»¥æŽ¥æ”¶å…¶ä»–å‚æ•°ä¼ é€’ç»™ç¬¬ä¸€ä¸ªå‚æ•°å‡½æ•°ï¼Œå¹¶ä¸” `async function` è¿”å›žå€¼æ˜¯å¯ä»¥è¢« `thenable` çš„ã€‚

```javascript
function co(gen) {
  const args = Array.prototype.slice.call(arguments, 1)
  return new Promise((resolve, reject) => {

  })
}
```

æ£€æµ‹å…¥å‚ï¼Œå¦‚æžœæ˜¯å‡½æ•°ç›´æŽ¥æ‰§è¡Œ(å¯èƒ½æ˜¯æ™®é€šå‡½æ•°æˆ– `generator`)ã€‚æ£€æŸ¥è¿”å›žå€¼å¦‚æžœä¸æ˜¯ä¸€ä¸ª `iterator` å°±ç›´æŽ¥ `resolve` æŽ‰ã€‚ï¼ˆæ¯æ¬¡æ–°å¢žçš„ä»£ç ä¼šé«˜äº®æ˜¾ç¤ºï¼‰

```javascript
function co(gen) {
  const args = Array.prototype.slice.call(arguments, 1)
  return new Promise((resolve, reject) => {
    // highlight-start
    if(typeof gen === "function") gen = gen.apply(this, args)
    if(!gen || typeof gen.next !== function) return resolve(gen)
    // highlight-end
  })
}
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ª `next`ï¼Œå¹¶æ£€æŸ¥è¿”å›žå€¼:

- å¦‚æžœ `done` ä¸ºçœŸï¼Œè¡¨ç¤ºæ‰§è¡Œç»“æŸï¼Œè¿”å›ž `value` å³å¯
- æ£€æŸ¥ `yield` çš„å€¼æ˜¯å¦å¯ä»¥è¢«è§„æ•´åŒ–ä¸º `Promise`ï¼Œ`co` çš„å®žçŽ°å¯ä»¥æ”¯æŒå¤šç§å½¢å¼çš„ `Promise`ï¼Œæ¯”å¦‚æ•°ç»„ï¼Œå¯¹è±¡ï¼Œå¯¹è¿™äº›æ‹“å±•æ„Ÿå…´è¶£å¯ä»¥çœ‹å…·ä½“çš„æºç å®žçŽ°ã€‚
  - å¯ä»¥ï¼šå–å¾— `resolve` çš„å€¼ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ª `next` è°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œå®Œæ‰€æœ‰çš„å‡½æ•°äº†
  - ä¸å¯ä»¥ï¼šç›´æŽ¥æŠ¥é”™

```javascript
function co(gen) {
  const args = Array.prototype.slice.call(arguments, 1)
  return new Promise((resolve, reject) => {
    if(typeof gen === "function") gen = gen.apply(this, args)
    if(!gen || typeof gen.next !== "function") return resolve(gen)
    // highlight-start

    onFulfilled()

    function onFulfilled(res) {
      let ret
      try {
        ret = gen.next(res)
      } catch(e) {
        return reject(e)
      }
      next(ret)
    }

    function onRejected(err) {
      let ret
      try {
        ret = gen.throw(err)
      } catch(e) {
        return reject(e)
      }
      next(ret)
    }

    function next(ret) {
      if(ret.done) return resolve(ret.value)
      if(isPromise(ret.value)) return ret.value.then(onFulfilled, onRejected)
      return onRejected(new TypeError("must yield a promise"))
    }
    // highlight-end
  })
}

function isPromise(obj) {
  return obj && "function" === typeof obj.then
}
```
